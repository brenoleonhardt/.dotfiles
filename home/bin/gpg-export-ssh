#!/usr/bin/env bash
#
# Exports a public gpg's ssh subkey capable of authenticating
#
# gpg's ssh keys can refer to multiple e-mails, so they end in openpgp:0xXXXXXXXX
# where XXXXXXXX is the short version of the signing-key's fingerprint

fingerprints=()
emails=()
selected_fingerprint=""
selected_email=""

while IFS=' ' read -r fingerprint email; do
	fingerprints+=("$fingerprint")
	emails+=("$email")
	if [[ -n "$1" ]] && [[ "$fingerprint" == *"$1" ]]; then
		selected_fingerprint=$fingerprint
		selected_email=$email
		break
	fi
done < <(
	gpg --list-keys --list-filter 'select=sub/usage=~a' --with-colons |
		awk -F: '/^fpr:/ {fpr=$10} /^uid:/ && fpr {
  email=$10;
  gsub(/.*<|>.*/, "", email);
  print fpr, email;
  fpr=""
}'
)

if [[ -z "$selected_fingerprint" ]]; then
	exec >&2
	echo "Usage: $(basename "$0") SUBKEY_FINGERPRINT"
	echo ""

	if [ ${#fingerprints[@]} -eq 0 ]; then
		echo "No fingerprint with authentication capability (A) found."
	fi

	if [ -n "$1" ]; then
		echo "\"$1\" does not match a fingerprint for subkey with capability (A)."
		echo ""
	fi

	if [ ${#fingerprints[@]} -gt 0 ]; then
		echo "Available subkeys:"
		printf -- "%s %s\n" "${fingerprints[@]}" "${emails[@]}"
	fi

	exit 1
fi

gpg --export-ssh-key "$selected_fingerprint" | awk -v email="$selected_email" '{print $1, $2, email}'
